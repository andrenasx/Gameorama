# A6: Indexes, triggers, user functions, transactions and population

This artefact contains the physical schema of the database, the identification and characterisation of the indexes, the support of data integrity rules with triggers and the definition of the database user-defined functions. This artefact shows the database transactions needed to assure the integrity of the data in the presence of concurrent accesses. For each transaction, the isolation level is explicitly stated and justified and read-only transactions to improve global performance are identified and justified. This artefact also contains the database's workload as well as the complete database creation script, including all SQL necessary to define all integrity constraints, indexes and triggers.

## 1. Database Workload

Understanding the nature of the workload for the application, and the performance goals, is essential to developing a good database design. The workload includes:

- the most important queries (SELECT) and how often they arise
- the most important modifications (UPDATE, DELETE) and how often they arise
- the desired performance for these queries and updates
- an estimate of the number of tuples for each relation

### 1.1. Tuple Estimation

The following table includes an estimation of the number of tuples and growth for each relation

| **Relation reference** | **Relation Name** | **Order of magnitude**        | **Estimated growth** |
| ------------------ | ------------- | ------------------------- | ---------------- |
| R01 | member_image | tens of thousands | tens per day |
| R02               | member | tens of thousands     | tens per day |
| R03               | member_follow | millions | thousands per day |
| R04               | administrator | tens                  | units per year   |
| R05               | news_post | hundreds of thousands | hundreds per day  |
| R06               | topic | thousands | tens per day      |
| R07               | topic_follow | hundreds of thousands | hundreds per day |
| R08               | post_topics | hundreds of thousands | hundreds per day |
| R09               | comment  | millions | thousands per day |
| R10              | reply | millions              | thousands per day |
| R11               | post_images | tens of thousands | hundreds per day |
| R12               | post_aura | millions | tens of thousands per day |
| R13               | comment_aura | millions              | tens of thousands per day |
| R14               | follow_notification | tens of thousands | tens per day      |
| R15          | comment_notification | tens of thousands     | tens per day      |
| R16             | reply_notification   | tens of thousands     | tens per day      |
| R17               | post_report | thousands             | units per day     |
| R18               | comment_report | tens of thousands | tens per day |
| R19          | topic_report         | hundreds         | units per day |
| R20              | member_report | hundreds        | units per day |

### 1.2. Frequent Queries

The following tables contain the most important queries (SELECT) and their frequency.  

| **Query**       | SELECT01                               |
| ---             | ---                                    |
| **Description** | Selects a member's information |
| **Frequency**   | tens of thousands per day |

#### SQL Code:

```sql
SELECT *
FROM member
NATURAL JOIN 
(SELECT id AS id_profile_image, file AS profile_image FROM member_image) AS member_profile_image
NATURAL JOIN 
(SELECT id AS id_banner_image, file AS banner_image FROM member_image) AS member_banner_image
WHERE member.id = $id_member;
```



| **Query**       | SELECT02                         |
| --------------- | -------------------------------- |
| **Description** | Selects a member's password hash |
| **Frequency**   | tens of thousands per day        |

#### SQL Code:

```sql
SELECT password 
FROM member 
WHERE username = $username;
```



| **Query**       | SELECT03                                                     |
| --------------- | ------------------------------------------------------------ |
| **Description** | Selects all news posts and their respective number of comments, sorted by recent |
| **Frequency**   | hundreds of thousands per day                                |

#### SQL Code:

```sql
SELECT * 
FROM news_post
NATURAL JOIN 
(SELECT id_post AS id, COUNT(*) AS num_comments FROM comment GROUP BY id_post) AS post_num_comments
ORDER BY news_post.date_time DESC;
```



| **Query**       | SELECT04                                                     |
| --------------- | ------------------------------------------------------------ |
| **Description** | Select main page's trending posts (posts from last 2 weeks with the most amount of aura score) |
| **Frequency**   | hundreds of thousands per day                                |

#### SQL Code:

```sql
SELECT * FROM news_post
WHERE date_time BETWEEN NOW()::DATE-EXTRACT(DOW FROM NOW())::INTEGER - 14 
AND NOW()::DATE-EXTRACT(DOW from NOW())::INTEGER + 1
ORDER BY aura DESC;
```



| **Query**       | SELECT05                                                     |
| --------------- | ------------------------------------------------------------ |
| **Description** | Select all posts from topics and members the member is following |
| **Frequency**   | hundreds of thousands per day                                |

#### SQL Code:

```sql
SELECT * FROM news_post WHERE id IN
(
    SELECT DISTINCT news_post.id FROM news_post 
    INNER JOIN post_topic ON news_post.id = post_topic.id_post
    INNER JOIN topic ON post_topic.id_topic = topic.id
    INNER JOIN member_follow ON member_follow.id_follower = $id_user
    WHERE topic.name IN
    (
        SELECT name FROM topic
        INNER JOIN topic_follow ON topic.id = topic_follow.id_topic
        WHERE topic_follow.id_member = $id_user
    )
	OR 
	member_follow.id_followed IN
	(
		SELECT id FROM news_post
		WHERE news_post.id_owner = $id_user
	)
) ORDER BY date_time DESC;
```



| **Query**       | SELECT06                       |
| --------------- | ------------------------------ |
| **Description** | Selects all topics from a post |
| **Frequency**   | hundreds of thousands per day  |

#### SQL Code:

```sql
SELECT * 
FROM post_topic 
INNER JOIN topic ON topic.id = post_topic.id_topic
WHERE id_post = $id_post;
```



| **Query**       | SELECT07                                             |
| --------------- | ---------------------------------------------------- |
| **Description** | Select all parent comments from a post (not replies) |
| **Frequency**   | hundreds of thousands per day                        |

#### SQL Code:

```sql
SELECT id, body, date_time, aura, id_member, id_post
FROM comment
WHERE id_post = $id_post 
AND id NOT IN (SELECT id_comment as id FROM reply WHERE id_post = $id_post);
```



| **Query**       | SELECT08                        |
| --------------- | ------------------------------- |
| **Description** | Select all replies to a comment |
| **Frequency**   | hundreds of thousands per day   |

#### SQL Code:

```sql
SELECT *
FROM reply
INNER JOIN comment ON id_comment = id
WHERE id_parent = $id_comment;
```



| **Query**       | SELECT09                                                     |
| --------------- | ------------------------------------------------------------ |
| **Description** | Select the 5 members with the most aura score (for the Hall of Fame) |
| **Frequency**   | hundreds of thousands per day                                |

#### SQL Code:

```sql
SELECT * 
FROM member
ORDER BY aura DESC LIMIT 5;
```



| **Query**       | SELECT10                                                     |
| --------------- | ------------------------------------------------------------ |
| **Description** | Select the 5 topics with the most followers (for the Most Popular Topics) |
| **Frequency**   | hundreds of thousands per day                                |

#### SQL Code:

```sql
SELECT * FROM topic
NATURAL JOIN 
(SELECT id_topic AS id, COUNT(*) AS num_followers FROM topic_follow GROUP BY id_topic) AS num_followers_topics
ORDER BY num_followers DESC
LIMIT 5;
```



| **Query**       | SELECT11                               |
| --------------- | -------------------------------------- |
| **Description** | Select all posts from a specific topic |
| **Frequency**   | hundreds of thousands per day          |

#### SQL Code:

```sql
SELECT * FROM news_post 
INNER JOIN post_topic ON news_post.id = post_topic.id_post
INNER JOIN topic ON post_topic.id_topic = topic.id
WHERE name = $name_topic;
```



| **Query**       | SELECT12                      |
| --------------- | ----------------------------- |
| **Description** | Select all posts from a user  |
| **Frequency**   | hundreds of thousands per day |

#### SQL Code:

```sql
SELECT * FROM news_post 
WHERE id_owner = $id_user;
```



| **Query**       | SELECT13                        |
| --------------- | ------------------------------- |
| **Description** | Select all comments from a user |
| **Frequency**   | hundreds of thousands per day   |

#### SQL Code:

```sql
SELECT * FROM comment
WHERE id_member = $id_user;
```





| **Query**       | SELECT14                         |
| --------------- | -------------------------------- |
| **Description** | Select the most reported members |
| **Frequency**   | hundreds per day                 |

#### SQL Code:

```sql
SELECT * FROM member
NATURAL JOIN (SELECT id_reported AS id, COUNT(*) AS num_reports FROM member_report GROUP BY id_reported) AS reported_members
ORDER BY num_reports DESC;
```



| **Query**       | SELECT15                       |
| --------------- | ------------------------------ |
| **Description** | Select the most reported posts |
| **Frequency**   | hundreds per day               |

#### SQL Code:

```sql
SELECT * FROM topic
NATURAL JOIN (SELECT id_topic AS id, COUNT(*) AS num_reports FROM topic_report GROUP BY id_topic) AS reported_topics
ORDER BY num_reports DESC;
```



| **Query**       | SELECT16                        |
| --------------- | ------------------------------- |
| **Description** | Select the most reported topics |
| **Frequency**   | hundreds per day                |

#### SQL Code:

```sql
SELECT * FROM topic
NATURAL JOIN (SELECT id_topic AS id, COUNT(*) AS num_reports FROM topic_report GROUP BY id_topic) AS reported_topics
ORDER BY num_reports DESC;
```



| **Query**       | SELECT17                          |
| --------------- | --------------------------------- |
| **Description** | Select the most reported comments |
| **Frequency**   | hundreds per day                  |

#### SQL Code:

```sql
SELECT * FROM comment
NATURAL JOIN (SELECT id_comment AS id, COUNT(*) AS num_reports FROM comment_report GROUP BY id_comment) AS reported_comments
ORDER BY num_reports DESC;
```



| **Query**       | SELECT18                                                     |
| --------------- | ------------------------------------------------------------ |
| **Description** | Select news posts with a title or content similar to the input searched |
| **Frequency**   | hundreds of thousands per day                                |

#### SQL Code:

```sql
SELECT * 
FROM news_post 
WHERE title @@ plainto_tsquery('english', $search);
```



| **Query**       | SELECT19                                                   |
| --------------- | ---------------------------------------------------------- |
| **Description** | Select users with a username similar to the input searched |
| **Frequency**   | hundreds of thousands per day                              |

#### SQL Code:

```sql
SELECT * 
FROM member 
WHERE username @@ plainto_tsquery('english', $search);
```



| **Query**       | SELECT20                                                |
| --------------- | ------------------------------------------------------- |
| **Description** | Select topics with a name similar to the input searched |
| **Frequency**   | hundreds of thousands per day                           |

#### SQL Code:

```sql
SELECT * 
FROM topic 
WHERE name @@ plainto_tsquery('english', $search);
```





### 1.3. Frequent Updates

The following tables contain most important updates (INSERT, UPDATE, DELETE) and their frequency.  

| **Query**       | UPDATE01                               |
| ---             | ---                                    |
| **Description** | Update member infomations (Edit profile page) |
| **Frequency**   | thousands per day     |

#### SQL Code:

```sql
UPDATE member SET full_name = $full_name, bio = $bio
WHERE id = $id_member
```



| **Query**       | UPDATE02                                        |
| --------------- | ----------------------------------------------- |
| **Description** | Update account settings (Account settings page) |
| **Frequency**   | thousands per day                               |

#### SQL Code:

```sql
UPDATE member SET password = $password_hash, email = $email
WHERE id = $id_member; 
```



| **Query**       | UPDATE03                                     |
| --------------- | -------------------------------------------- |
| **Description** | Update news post's information (Edit a post) |
| **Frequency**   | thousands per day                            |

#### SQL Code:

```sql
UPDATE news_post SET title = $title, body = $body
WHERE id = $id_post;
```



| **Query**       | UPDATE04                  |
| --------------- | ------------------------- |
| **Description** | Update a vote from a post |
| **Frequency**   | thousands per day         |

#### SQL Code:

```sql
UPDATE post_aura SET upvote = $upvote
WHERE id_post = $id_post
AND id_voter = $id_voter
```



| **Query**       | UPDATE05                     |
| --------------- | ---------------------------- |
| **Description** | Update a vote from a comment |
| **Frequency**   | thousands per day            |

#### SQL Code:

```sql
UPDATE comment_aura SET upvote = $upvote
WHERE id_comment = $id_comment
AND id_voter = $id_voter
```



| **Query**       | INSERT01            |
| --------------- | ------------------- |
| **Description** | Insert member image |
| **Frequency**   | tens per day        |

#### SQL Code:

```sql
insert into member_image (file) values ($file));
```



| **Query**       | INSERT02      |
| --------------- | ------------- |
| **Description** | Insert member |
| **Frequency**   | tens per day  |

#### SQL Code:

```sql
INSERT INTO member (username, full_name, email, password, bio, id_profile_image, id_banner_image) VALUES ($username, $full_name, $email, $password, $bio, $id_profile_image, $id_banner_image);
```



| **Query**       | INSERT03             |
| --------------- | -------------------- |
| **Description** | Insert administrator |
| **Frequency**   | units per year       |

#### SQL Code:

```sql
INSERT INTO administrator (id) VALUES ($id);
```



| **Query**       | INSERT04             |
| --------------- | -------------------- |
| **Description** | Insert member_follow |
| **Frequency**   | thousands per day    |

#### SQL Code:

```sql
INSERT INTO member_follow (id_followed, id_follower) VALUES ($id_followed, $id_follower);
```



| **Query**       | INSERT05         |
| --------------- | ---------------- |
| **Description** | Insert news_post |
| **Frequency**   | hundreds per day |

#### SQL Code:

```sql
INSERT INTO news_post (title, body, date_time, id_owner) VALUES ($title, $body, $date_time, $id_owner);
```



| **Query**       | INSERT06     |
| --------------- | ------------ |
| **Description** | Insert topic |
| **Frequency**   | tens per day |

#### SQL Code:

```sql
INSERT INTO topic (name) VALUES ($name) ON CONFLICT DO NOTHING;
```



| **Query**       | INSERT07            |
| --------------- | ------------------- |
| **Description** | Insert topic_follow |
| **Frequency**   | hundreds per day    |

#### SQL Code:

```sql
INSERT INTO topic_follow (id_topic, id_member) VALUES ($id_topic, $id_member);
```



| **Query**       | INSERT08          |
| --------------- | ----------------- |
| **Description** | Insert post_topic |
| **Frequency**   | hundreds per day  |

#### SQL Code:

```sql
INSERT INTO post_topic (id_topic,id_post) VALUES ($id_topic, $id_post);
```



| **Query**       | INSERT09          |
| --------------- | ----------------- |
| **Description** | Insert comment    |
| **Frequency**   | thousands per day |

#### SQL Code:

```sql
INSERT INTO comment (body, date_time, id_member, id_post) VALUES ($body, $date_time, $id_member, $id_post);
```



| **Query**       | INSERT10          |
| --------------- | ----------------- |
| **Description** | Insert reply      |
| **Frequency**   | thousands per day |

#### SQL Code:

```sql
INSERT INTO reply (id_comment, id_parent) VALUES ($id_comment, $id_parent);
```



| **Query**       | INSERT11          |
| --------------- | ----------------- |
| **Description** | Insert post_image |
| **Frequency**   | hundreds per day  |

#### SQL Code:

```sql
INSERT INTO post_image (id_post, file) VALUES ($id_post, $file);
```



| **Query**       | INSERT12                  |
| --------------- | ------------------------- |
| **Description** | Insert post_aura          |
| **Frequency**   | tens of thousands per day |

#### SQL Code:

```sql
INSERT INTO post_aura (id_post, id_voter, upvote) VALUES ($id_post, $id_voter, $upvote);
```



| **Query**       | INSERT13                  |
| --------------- | ------------------------- |
| **Description** | Insert comment_aura       |
| **Frequency**   | tens of thousands per day |

#### SQL Code:

```sql
INSERT INTO comment_aura (id_comment, id_voter, upvote) VALUES ($id_comment, $id_voter, $upvote);
```



| **Query**       | INSERT14                   |
| --------------- | -------------------------- |
| **Description** | Insert follow_notification |
| **Frequency**   | units per day              |

#### SQL Code:

```sql
INSERT INTO follow_notification (id_followed, id_follower) VALUES ($id_followed, $id_follower);
```



| **Query**       | INSERT15                    |
| --------------- | --------------------------- |
| **Description** | Insert comment_notification |
| **Frequency**   | units per day               |

#### SQL Code:

```sql
INSERT INTO comment_notification (id_notified, id_comment) VALUES ($id_notified, $id_comment);
```



| **Query**       | INSERT16                  |
| --------------- | ------------------------- |
| **Description** | Insert reply_notification |
| **Frequency**   | units per day             |

#### SQL Code:

```sql
INSERT INTO reply_notification (id_notified, id_comment) VALUES ($id_notified, $id_comment);
```



| **Query**       | INSERT17           |
| --------------- | ------------------ |
| **Description** | Insert post_report |
| **Frequency**   | units per day      |

#### SQL Code:

```sql
INSERT INTO post_report (id_reporter, id_post, body) VALUES ($id_reporter, $id_post, $body);
```



| **Query**       | INSERT18              |
| --------------- | --------------------- |
| **Description** | Insert comment_report |
| **Frequency**   | tens per day          |

#### SQL Code:

```sql
INSERT INTO comment_report (id_reporter, id_comment, body) VALUES ($id_reporter, $id_comment, $body);
```



| **Query**       | INSERT19            |
| --------------- | ------------------- |
| **Description** | Insert topic_report |
| **Frequency**   | units per day       |

#### SQL Code:

```sql
INSERT INTO topic_report (id_reporter, id_topic, body) VALUES ($id_reporter, $id_topic, $body);
```



| **Query**       | INSERT20             |
| --------------- | -------------------- |
| **Description** | Insert member_report |
| **Frequency**   | units per day        |

#### SQL Code:

```sql
INSERT INTO member_report (id_reporter, id_reported, body) VALUES ($id_reporter, $id_reported, $body);
```



| **Query**       | DELETE01        |
| --------------- | --------------- |
| **Description** | Delete a member |
| **Frequency**   | units per day   |

#### SQL Code:

```sql
DELETE FROM member WHERE id = $id_member;
```


| **Query**       | DELETE02              |
| --------------- | --------------------- |
| **Description** | Delete a member_image |
| **Frequency**   | units per day         |

#### SQL Code:

```sql
DELETE FROM member_image WHERE id = $id_image;
```



| **Query**       | DELETE03               |
| --------------- | ---------------------- |
| **Description** | Delete a member_follow |
| **Frequency**   | hundreds per day       |

#### SQL Code:

```sql
DELETE FROM member_follow
WHERE id_follower = $id_follower
AND id_followed = $id_followed;
```



| **Query**       | DELETE04              |
| --------------- | --------------------- |
| **Description** | Delete a topic_follow |
| **Frequency**   | tens per day          |

#### SQL Code:

```sql
DELETE FROM topic_follow
WHERE id_member = $id_member
AND id_topic = $id_topic;
```



| **Query**       | DELETE05           |
| --------------- | ------------------ |
| **Description** | Delete a news_post |
| **Frequency**   | tens per day       |

#### SQL Code:

```sql
DELETE FROM news_post WHERE id = $id_post;
```



| **Query**       | DELETE06         |
| --------------- | ---------------- |
| **Description** | Delete a comment |
| **Frequency**   | tens per day     |

#### SQL Code:

```sql
DELETE FROM comment WHERE id = $id_comment;
```



| **Query**       | DELETE07           |
| --------------- | ------------------ |
| **Description** | Delete a post_aura |
| **Frequency**   | thousands per day  |

#### SQL Code:

```sql
DELETE FROM post_aura
WHERE id_post = $id_post
AND id_voter = $id_voter
```



| **Query**       | DELETE08              |
| --------------- | --------------------- |
| **Description** | Delete a comment_aura |
| **Frequency**   | thousands per day     |

#### SQL Code:

```sql
DELETE FROM comment_aura
WHERE id_comment = $id_comment
AND id_voter = $id_voter
```



## 2. Proposed Indices

### 2.1. Performance Indexes

The following tables display the indexes proposed to improve performance of the identified queries.  

| **Index**           | IDX01                                                        |
| ------------------- | ------------------------------------------------------------ |
| **Related queries** | SELECT03                                                     |
| **Relation**        | news_post                                                    |
| **Attribute**       | date_time                                                    |
| **Type**            | B-tree                                                       |
| **Cardinality**     | Low                                                          |
| **Clustering**      | No                                                           |
| **Justification**   | This index allows the news posts to be searched by date faster. Allowing the mainpage information to be loaded quickly. |

####  SQL Code:

```sql
DROP INDEX IF EXISTS news_post_date;
CREATE INDEX post_date ON news_post USING btree (date_time);
```



| **Index**           | IDX02                                                        |
| ------------------- | ------------------------------------------------------------ |
| **Related queries** | SELECT07                                                     |
| **Relation**        | comment                                                      |
| **Attribute**       | id_post                                                      |
| **Type**            | Hash                                                         |
| **Cardinality**     | Medium                                                       |
| **Clustering**      | No                                                           |
| **Justification**   | Due to the quantity of comments present in the table, this index reduces the query execution time allowing the comment to be fetched fast for the news post's page. |

####  SQL Code:

```sql
DROP INDEX IF EXISTS search_comment_post;
CREATE INDEX search_comment_post ON comment USING hash (id_post);
```


| **Index**           | IDX03                                                        |
| ------------------- | ------------------------------------------------------------ |
| **Related queries** | SELECT12                                                     |
| **Relation**        | news_post                                                    |
| **Attribute**       | id_member                                                    |
| **Type**            | Hash                                                         |
| **Cardinality**     | Medium                                                       |
| **Clustering**      | No                                                           |
| **Justification**   | Due to the quantity of comments present in the table, this index reduces the query execution time allowing the posts to be fetched fast for the user's profile page. |

####  SQL Code:

```sql
DROP INDEX IF EXISTS search_post_member;
CREATE INDEX search_post_member ON news_post USING hash (id_member);
```


| **Index**           | IDX04                                                        |
| ------------------- | ------------------------------------------------------------ |
| **Related queries** | SELECT13                                                     |
| **Relation**        | comment                                                      |
| **Attribute**       | id_member                                                    |
| **Type**            | Hash                                                         |
| **Cardinality**     | Medium                                                       |
| **Clustering**      | No                                                           |
| **Justification**   | Due to the quantity of comments present in the table, this index reduces the query execution time allowing the comments to be fetched fast for the user's profile page. |

####  SQL Code:

```sql
DROP INDEX IF EXISTS search_comment_member;
CREATE INDEX search_comment_member ON comment USING hash (id_member);
```



### 2.2. Full-text Search Indexes

The following tables specify the indexes created in order to achieve full-text search and its features.

| **Index**           | IDX05                                                        |
| ------------------- | ------------------------------------------------------------ |
| **Related queries** | SELECT18                                                     |
| **Relation**        | news_post                                                    |
| **Attribute**       | title                                                        |
| **Type**            | GiST                                                         |
| **Clustering**      | No                                                           |
| **Justification**   | To improve the performance of full text searches while searching for news posts' titles. The type of this index is GiST because it's better for dynamic data. |

####  SQL Code:

```sql
DROP INDEX IF EXISTS search_posts;
CREATE INDEX search_posts ON news_post USING gist (to_tsvector('english', title));
```



| **Index**           | IDX06                                                        |
| ------------------- | ------------------------------------------------------------ |
| **Related queries** | SELECT19                                                     |
| **Relation**        | member                                                       |
| **Attribute**       | username                                                     |
| **Type**            | GiST                                                         |
| **Clustering**      | No                                                           |
| **Justification**   | To improve the performance of full text searches while searching for members' usenames. The type of this index is GiST because it's better for dynamic data. |

####  SQL Code:

```sql
DROP INDEX IF EXISTS member_username;
CREATE INDEX IF NOT EXISTS member_username ON member USING gist (to_tsvector('english', username));
```



| **Index**           | IDX07                                                        |
| ------------------- | ------------------------------------------------------------ |
| **Related queries** | SELECT20                                                     |
| **Relation**        | topic                                                        |
| **Attribute**       | name                                                         |
| **Type**            | GIN                                                          |
| **Clustering**      | No                                                           |
| **Justification**   | To improve the performance of full text searches while searching for topics' names. Seeing that this table is infrequently updated the type of index used is GIN, which take longer to create/update but lead to faster lookups. |

#### SQL Code:

```sql
DROP INDEX IF EXISTS topic_name;
CREATE INDEX topic_name ON topic USING gin (to_tsvector('english', name));
```



## 3. Triggers

The following tables define the triggers and user-defined functions developed in order to maintain the system's data integrity.

| **Trigger**      | TRIGGER01                              |
| ---              | ---                                    |
| **Description**  | When a post already has a vote (upvote or downvote)  and a member changes its vote, the old vote is removed and the post's and its owner's aura score is updated (+2 on upvotes or -2 on downvotes) |

####  SQL Code:

```sql
DROP FUNCTION IF EXISTS update_post_aura CASCADE;
CREATE FUNCTION update_post_aura() RETURNS TRIGGER AS $$
  BEGIN
    IF NEW.upvote AND NOT OLD.upvote THEN
      UPDATE news_post
        SET aura = aura + 2
        WHERE NEW.id_post = news_post.id;
      UPDATE member
        SET aura = aura + 2
        WHERE NEW.id_voter = member.id;

    ELSIF NOT NEW.upvote AND OLD.upvote THEN
      UPDATE news_post
        SET aura = aura - 2
        WHERE NEW.id_post = news_post.id;
      UPDATE member
        SET aura = aura - 2
        WHERE NEW.id_voter = member.id;
    END IF;
    RETURN NEW;
  END;
  $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS update_post_aura ON post_aura CASCADE;
CREATE TRIGGER update_post_aura
	BEFORE UPDATE ON post_aura
	FOR EACH ROW EXECUTE PROCEDURE update_post_aura();
```



| **Trigger**     | TRIGGER02                                                    |
| --------------- | ------------------------------------------------------------ |
| **Description** | When a post doesn't have a vote yet and a member votes, the new vote is added and the post's and its owner's aura score is updated (+1 on upvotes or -1 on downvotes) |

#### SQL Code:

```sql
DROP FUNCTION IF EXISTS insert_post_aura CASCADE;
CREATE FUNCTION insert_post_aura() RETURNS TRIGGER AS $$
  BEGIN
    IF NEW.upvote THEN
      UPDATE news_post
        SET aura = aura + 1
        WHERE NEW.id_post = news_post.id;
      UPDATE member
        SET aura = aura + 1
        WHERE NEW.id_voter = member.id;

    ELSIF NOT NEW.upvote THEN
      UPDATE news_post
        SET aura = aura - 1
        WHERE NEW.id_post = news_post.id;
      UPDATE member
        SET aura = aura - 1
        WHERE NEW.id_voter = member.id;
    END IF;
    RETURN NEW;
  END;
  $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS insert_post_aura ON post_aura CASCADE;
CREATE TRIGGER insert_post_aura
  BEFORE INSERT ON post_aura
  FOR EACH ROW EXECUTE PROCEDURE insert_post_aura();
```



| **Trigger**     | TRIGGER03                                                    |
| --------------- | ------------------------------------------------------------ |
| **Description** | When a post already has a vote and the member removes it, the vote is removed and the post's and its owner's aura score is updated (-1 on removing an upvote or +1 on removing a downvote) |

#### SQL Code:

```sql
DROP FUNCTION IF EXISTS delete_post_aura CASCADE;
CREATE FUNCTION delete_post_aura() RETURNS TRIGGER AS $$
  BEGIN
    IF OLD.upvote THEN
      UPDATE news_post
        SET aura = aura - 1
        WHERE OLD.id_post = news_post.id;
      UPDATE member
        SET aura = aura - 1
        WHERE OLD.id_voter = member.id;

    ELSIF NOT OLD.upvote THEN
      UPDATE news_post
        SET aura = aura + 1
        WHERE OLD.id_post = news_post.id;
      UPDATE member
        SET aura = aura + 1
        WHERE OLD.id_voter = member.id;
    END IF;
    RETURN NEW;
  END;
  $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS delete_post_aura ON post_aura CASCADE;
CREATE TRIGGER delete_post_aura
    BEFORE DELETE ON post_aura
    FOR EACH ROW EXECUTE PROCEDURE delete_post_aura();
```



| **Trigger**     | TRIGGER04                                                    |
| --------------- | ------------------------------------------------------------ |
| **Description** | When a comment already has a vote (upvote or downvote)  and a member changes its vote, the old vote is removed and the comment's and its owner's aura score is updated (+2 on upvotes or -2 on downvotes) |

#### SQL Code:

```sql
DROP FUNCTION IF EXISTS update_comment_aura CASCADE;
CREATE FUNCTION update_comment_aura() RETURNS TRIGGER AS $$
  BEGIN
    IF NEW.upvote AND NOT OLD.upvote THEN
      UPDATE comment
        SET aura = aura + 2
        WHERE NEW.id_comment = comment.id;    
      UPDATE member
        SET aura = aura + 2
        WHERE NEW.id_voter = member.id;

    ELSIF NOT NEW.upvote AND OLD.upvote THEN
      UPDATE comment
        SET aura = aura - 2
        WHERE NEW.id_comment = comment.id;
      UPDATE member
        SET aura = aura - 2
        WHERE NEW.id_voter = member.id;
    END IF;
    RETURN NEW;
  END;
  $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS update_comment_aura ON comment_aura CASCADE;
CREATE TRIGGER update_comment_aura
	BEFORE UPDATE ON comment_aura
	FOR EACH ROW EXECUTE PROCEDURE update_comment_aura();
```



| **Trigger**     | TRIGGER05                                                    |
| --------------- | ------------------------------------------------------------ |
| **Description** | When a comment doesn't have a vote yet and a member votes, the new vote is added and the comment's and its owner's aura score is updated (+1 on upvotes or -1 on downvotes) |

#### SQL Code:

```sql
DROP FUNCTION IF EXISTS insert_comment_aura CASCADE;
CREATE FUNCTION insert_comment_aura() RETURNS TRIGGER AS $$
  BEGIN
    IF NEW.upvote THEN
      UPDATE comment
        SET aura = aura + 1
        WHERE NEW.id_comment = comment.id;
      UPDATE member
        SET aura = aura + 1
        WHERE NEW.id_voter = member.id;

    ELSIF NOT NEW.upvote THEN
      UPDATE comment
        SET aura = aura - 1
        WHERE NEW.id_comment = comment.id;
      UPDATE member
        SET aura = aura - 1
        WHERE NEW.id_voter = member.id;
    END IF;
    RETURN NEW;
  END;
  $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS insert_comment_aura ON comment_aura CASCADE;
CREATE TRIGGER insert_comment_aura
  BEFORE INSERT ON comment_aura
  FOR EACH ROW EXECUTE PROCEDURE insert_comment_aura();
```



| **Trigger**     | TRIGGER06                                                    |
| --------------- | ------------------------------------------------------------ |
| **Description** | When a comment already has a vote and the member removes it, the vote is removed and the comment's and its owner's aura score is updated (-1 on removing an upvote or +1 on removing a downvote) |

#### SQL Code:

```sql
DROP FUNCTION IF EXISTS delete_comment_aura CASCADE;
CREATE FUNCTION delete_comment_aura() RETURNS TRIGGER AS $$
  BEGIN
    IF OLD.upvote THEN
      UPDATE comment
        SET aura = aura - 1
        WHERE OLD.id_comment = comment.id;
      UPDATE member
        SET aura = aura - 1
        WHERE OLD.id_voter = member.id;

    ELSIF NOT OLD.upvote THEN
      UPDATE comment
        SET aura = aura + 1
        WHERE OLD.id_comment = comment.id;
      UPDATE member
        SET aura = aura + 1
        WHERE OLD.id_voter = member.id;
    END IF;
    RETURN NEW;
  END;
  $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS delete_comment_aura ON comment_aura CASCADE;
CREATE TRIGGER delete_comment_aura
  BEFORE DELETE ON comment_aura
  FOR EACH ROW EXECUTE PROCEDURE delete_comment_aura();
```



| **Trigger**     | TRIGGER07                                                    |
| --------------- | ------------------------------------------------------------ |
| **Description** | Guarantees that a post has a minimum of 1 and a maximum of 10 topics |

#### SQL Code:

```sql
DROP FUNCTION IF EXISTS check_topics CASCADE;
CREATE FUNCTION check_topics() RETURNS TRIGGER AS $$
  DECLARE num_topics SMALLINT;
  DECLARE current RECORD;
  BEGIN
    IF TG_OP = 'INSERT' THEN
      current = NEW;
    ELSE
      current = OLD;
    END IF;
    SELECT INTO num_topics count(*)
    FROM post_topic
    WHERE current.id_post = post_topic.id_post;
    IF num_topics > 10 THEN
      RAISE EXCEPTION 'A post can only have a maximum of 10 topics';
    ELSIF num_topics < 1 THEN
      RAISE EXCEPTION 'A post must have at least 1 topic';
    END IF;
    RETURN NEW;
  END;
  $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS check_topics ON post_topic CASCADE;
CREATE TRIGGER check_topics
  AFTER INSERT OR DELETE ON post_topic
  FOR EACH ROW EXECUTE PROCEDURE check_topics();
```



| **Trigger**     | TRIGGER08                                                    |
| --------------- | ------------------------------------------------------------ |
| **Description** | Guarantees that a comment's date is after its parent post's date |

#### SQL Code:

```sql
DROP FUNCTION IF EXISTS check_date_post CASCADE;
CREATE FUNCTION check_date_post() RETURNS TRIGGER AS $$
  BEGIN
    IF EXISTS (SELECT news_post.date_time FROM comment INNER JOIN news_post 
      ON comment.id_post = news_post.id
      WHERE comment.date_time < news_post.date_time)
      THEN
        RAISE EXCEPTION 'A comment can only be posted after the post it refers to.';
    END IF;
    RETURN NEW;
  END;
  $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS check_date_post ON comment CASCADE;
CREATE TRIGGER check_date_post 
  BEFORE INSERT ON comment
  FOR EACH ROW
  EXECUTE PROCEDURE check_date_post();
```





| **Trigger**     | TRIGGER09                                                    |
| --------------- | ------------------------------------------------------------ |
| **Description** | Guarantees that a reply's date is after its parent comment's date |

#### SQL Code:

```sql
DROP FUNCTION IF EXISTS check_date_comment CASCADE;
CREATE FUNCTION check_date_comment() RETURNS TRIGGER AS $$
  BEGIN
    IF EXISTS (SELECT C1.date_time FROM comment C1 INNER JOIN reply 
      ON C1.id = reply.id_parent
      INNER JOIN comment C2 
      ON C2.id = reply.id_comment
      WHERE C2.date_time < C1.date_time)
      THEN
        RAISE EXCEPTION 'A reply can only be posted after the comment it refers to.';
    END IF;
    RETURN NEW;
  END;
  $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS check_date_comment ON comment CASCADE;
CREATE TRIGGER check_date_comment
  BEFORE INSERT ON comment
  FOR EACH ROW
  EXECUTE PROCEDURE check_date_comment();
```



| **Trigger**     | TRIGGER10                                                    |
| --------------- | ------------------------------------------------------------ |
| **Description** | Creates a follow notification for the member that got followed |

#### SQL Code:

```sql
DROP FUNCTION IF EXISTS create_follow_notification CASCADE;
CREATE FUNCTION create_follow_notification() RETURNS TRIGGER AS $$
  BEGIN
    INSERT INTO follow_notification (id_notified, id_follower, date_time) VALUES (NEW.id_followed, NEW.id_follower, now());
    RETURN NULL;
  END;
  $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS create_follow_notification ON member_follow CASCADE;
CREATE TRIGGER create_follow_notification
  AFTER INSERT ON member_follow
  FOR EACH ROW EXECUTE PROCEDURE create_follow_notification();
```



| **Trigger**     | TRIGGER11                                                    |
| --------------- | ------------------------------------------------------------ |
| **Description** | Creates a comment notification for a member if someone comments on a post made by them |

#### SQL Code:

```sql
DROP FUNCTION IF EXISTS create_comment_notification CASCADE;
CREATE FUNCTION create_comment_notification() RETURNS TRIGGER AS $$
  BEGIN
    INSERT INTO comment_notification (id_notified, id_comment, date_time) VALUES ((SELECT id_owner FROM news_post WHERE news_post.id=NEW.id_post), NEW.id, now());
    RETURN NULL;
  END;
  $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS create_comment_notification ON comment CASCADE;
CREATE TRIGGER create_comment_notification
  AFTER INSERT ON comment
  FOR EACH ROW EXECUTE PROCEDURE create_comment_notification();
```



| **Trigger**     | TRIGGER12                                                    |
| --------------- | ------------------------------------------------------------ |
| **Description** | Creates a reply notification for a member if someone replies to a comment made by them |

#### SQL Code:

```sql
DROP FUNCTION IF EXISTS create_reply_notification CASCADE; 
CREATE FUNCTION create_reply_notification() RETURNS TRIGGER AS $$
  BEGIN
    INSERT INTO reply_notification (id_notified, id_reply, date_time) VALUES ((SELECT id_member FROM comment WHERE comment.id=NEW.id_parent), NEW.id_comment, now());
    RETURN NULL;
  END;
  $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS create_reply_notification ON reply CASCADE;
CREATE TRIGGER create_reply_notification
  AFTER INSERT ON reply
  FOR EACH ROW EXECUTE PROCEDURE create_reply_notification();
```





## 4. Transactions

The following tables display the transactions needed to assure the integrity of the data in the presence of concurrent accesses.  

| **T01**   |  Insert replies                 |
| --------------- | ----------------------------------- |
| Justification   |  It is necessary to ensure a ROLLBACK in case any of the transaction's instructions result in an error. The isolation level is Repeatable Read, because, otherwise, an update of comment_id_seq could happen, due to an insert in the table comment committed by a concurrent transaction, and as a result, inconsistent data would be stored. |
| Isolation level | REPEATABLE READ                     |

#### SQL Code:
```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ

  INSERT INTO comment (body, id_member, id_post) VALUES ($body, $id_member, $id_post);
  INSERT INTO reply (id_comment, id_parent) VALUES (currval('comment_id_seq'), $id_parent);

COMMIT;
```
---


## Annex A. SQL Code

### A.1. Database schema

```sql
-----------------------------------------
-- Drop old schmema
-----------------------------------------

DROP TABLE IF EXISTS member CASCADE;
DROP TABLE IF EXISTS member_image CASCADE;
DROP TABLE IF EXISTS member_follow CASCADE;
DROP TABLE IF EXISTS administrator CASCADE;
DROP TABLE IF EXISTS news_post CASCADE;
DROP TABLE IF EXISTS topic CASCADE;
DROP TABLE IF EXISTS topic_follow CASCADE;
DROP TABLE IF EXISTS post_topic CASCADE;
DROP TABLE IF EXISTS comment CASCADE;
DROP TABLE IF EXISTS reply CASCADE;
DROP TABLE IF EXISTS post_image CASCADE;
DROP TABLE IF EXISTS post_aura CASCADE;
DROP TABLE IF EXISTS comment_aura CASCADE;
DROP TABLE IF EXISTS follow_notification CASCADE;
DROP TABLE IF EXISTS comment_notification CASCADE;
DROP TABLE IF EXISTS reply_notification CASCADE;
DROP TABLE IF EXISTS post_report CASCADE;
DROP TABLE IF EXISTS comment_report CASCADE;
DROP TABLE IF EXISTS topic_report CASCADE;
DROP TABLE IF EXISTS member_report CASCADE;


-----------------------------------------
-- Create tables
-----------------------------------------

CREATE TABLE member_image (
    id serial PRIMARY KEY,
    file bytea NOT NULL
);

CREATE TABLE member (
    id serial PRIMARY KEY,
    username text NOT NULL UNIQUE,
    full_name text NOT NULL,
    email text NOT NULL UNIQUE,
    password text NOT NULL,
    bio text,
    id_profile_image integer NOT NULL REFERENCES member_image(id),
    id_banner_image integer NOT NULL REFERENCES member_image(id),
    aura integer DEFAULT 0 NOT NULL
);

CREATE TABLE administrator (
    id integer PRIMARY KEY REFERENCES member(id)
);

CREATE TABLE member_follow (
    id_followed integer REFERENCES member(id) ON DELETE CASCADE,
    id_follower integer REFERENCES member(id) ON DELETE CASCADE,
    PRIMARY KEY(id_follower, id_followed),
    CONSTRAINT follow_ids CHECK (id_followed <> id_follower)
);

CREATE TABLE news_post (
    id serial PRIMARY KEY,
    title text NOT NULL,
    body text,
    date_time timestamp NOT NULL DEFAULT now(),
    aura integer DEFAULT 0 NOT NULL,
    id_owner integer NOT NULL REFERENCES member(id) ON DELETE CASCADE
);

CREATE TABLE topic (
    id serial PRIMARY KEY,
    name text NOT NULL UNIQUE
);

CREATE TABLE topic_follow (
    id_topic integer REFERENCES topic(id) ON DELETE CASCADE,
    id_member integer REFERENCES member(id) ON DELETE CASCADE,
    PRIMARY KEY(id_topic, id_member)
);

CREATE TABLE post_topic (
    id_post integer REFERENCES news_post(id) ON DELETE CASCADE,
    id_topic integer REFERENCES topic(id) ON DELETE CASCADE,
    PRIMARY KEY(id_post, id_topic)
);

CREATE TABLE comment (
    id serial PRIMARY KEY,
    body text NOT NULL,
    date_time timestamp NOT NULL DEFAULT now(),
    aura integer DEFAULT 0 NOT NULL,
    id_member integer NOT NULL REFERENCES member(id) ON DELETE CASCADE,
    id_post integer NOT NULL REFERENCES news_post(id) ON DELETE CASCADE
);

CREATE TABLE reply (
    id_comment integer PRIMARY KEY REFERENCES comment(id) ON DELETE CASCADE,
    id_parent integer NOT NULL REFERENCES comment(id) ON DELETE CASCADE,
    CONSTRAINT reply_ids CHECK (id_comment <> id_parent)
);

CREATE TABLE post_image (
    id serial PRIMARY KEY,
    id_post integer NOT NULL REFERENCES news_post(id) ON DELETE CASCADE,
    file bytea NOT NULL
);

CREATE TABLE post_aura (
    id_post integer REFERENCES news_post(id) ON DELETE CASCADE,
    id_voter integer REFERENCES member(id) ON DELETE CASCADE,
    upvote boolean NOT NULL,
    PRIMARY KEY(id_post, id_voter)
);

CREATE TABLE comment_aura (
    id_comment integer REFERENCES comment(id) ON DELETE CASCADE,
    id_voter integer REFERENCES member(id) ON DELETE CASCADE,
    upvote boolean NOT NULL,
    PRIMARY KEY(id_comment, id_voter)
);

CREATE TABLE follow_notification (
    id_notified integer REFERENCES member(id) ON DELETE CASCADE,
    id_follower integer REFERENCES member(id) ON DELETE CASCADE,
    date_time timestamp NOT NULL DEFAULT now(),
    PRIMARY KEY(id_notified, id_follower),
    CONSTRAINT follow_notification_ids CHECK (id_follower <> id_notified)
);

CREATE TABLE comment_notification (
    id_notified integer REFERENCES member(id) ON DELETE CASCADE,
    id_comment integer REFERENCES comment(id) ON DELETE CASCADE,
    date_time timestamp NOT NULL DEFAULT now(),
    PRIMARY KEY(id_notified, id_comment)
);

CREATE TABLE reply_notification (
    id_notified integer REFERENCES member(id) ON DELETE CASCADE,
    id_reply integer REFERENCES reply(id_comment) ON DELETE CASCADE,
    date_time timestamp NOT NULL DEFAULT now(),
    PRIMARY KEY(id_notified, id_reply)
);

CREATE TABLE post_report (
    id_reporter integer REFERENCES member(id) ON DELETE SET NULL,
    id_post integer REFERENCES news_post(id) ON DELETE CASCADE,
    body text NOT NULL,
    date_time timestamp NOT NULL DEFAULT now(),
    PRIMARY KEY(id_reporter, id_post)
);

CREATE TABLE comment_report (
    id_reporter integer REFERENCES member(id) ON DELETE SET NULL,
    id_comment integer REFERENCES comment(id) ON DELETE CASCADE,
    body text NOT NULL,
    date_time timestamp NOT NULL DEFAULT now(),
    PRIMARY KEY(id_reporter, id_comment)
);

CREATE TABLE topic_report (
    id_reporter integer REFERENCES member(id) ON DELETE SET NULL,
    id_topic integer REFERENCES topic(id) ON DELETE CASCADE,
    body text NOT NULL,
    date_time timestamp NOT NULL DEFAULT now(),
    PRIMARY KEY(id_reporter, id_topic)
);

CREATE TABLE member_report (
    id_reporter integer REFERENCES member(id) ON DELETE SET NULL,
    id_reported integer REFERENCES member(id) ON DELETE CASCADE,
    body text NOT NULL,
    date_time timestamp NOT NULL DEFAULT now(),
    PRIMARY KEY(id_reporter, id_reported),
    CONSTRAINT member_report_ids CHECK (id_reporter <> id_reported)
);
```

### A.2. Database population

Because populate.sql is too large to fit here, the link to its separate file in the repository is present here: [populate.sql](https://git.fe.up.pt/lbaw/lbaw2021/lbaw2133/-/blob/master/artefacts/ebd/a6/populate.sql)

## Revision history

Changes made to the first submission: N/A

***
GROUP2133, 30/03/2021

* Andr√© Nascimento, up201806461@fe.up.pt
* Caio Nogueira, up201806218@fe.up.pt
* Diogo Almeida (editor), up201806630@fe.up.pt
* Gustavo Sena, up201806078@fe.up.pt